<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Container Security Report</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    table { border-collapse: collapse; margin-bottom: 40px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    h2 { margin-top: 60px; }
    .green { color: green; }
    .red { color: red; }
  </style>
</head>
<body>
  <h1>Container Image Security Overview</h1>
  <script>
    async function load() {
      const files = await fetch('data/index.json').then(r => r.json());
      const container = document.body;

      for (const file of files) {
        const data = await fetch(`data/${file}`).then(r => r.json());
        const appName = file.replace('.json', '');
        const upstream = data.upstream?.version || 'Unknown';
        const images = data.images || {};

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>Image</th>
            <th>amd64 Size (MB)</th>
            <th>arm64 Size (MB)</th>
            <th>Detected Version</th>
            <th>Trivy (Crit | High | Med | Low)</th>
            <th>Grype (Crit | High | Med | Low)</th>
          </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        for (const [imageName, details] of Object.entries(images)) {
          const row = document.createElement('tr');

          const get = (obj, key) => obj?.[key] || '';

          const sizeAmd = get(details, 'amd64')?.size_mb || '';
          const sizeArm = get(details, 'arm64')?.size_mb || '';
          const version = get(details, 'detected_version') || '';

          const cves = (tool) => {
            const vals = ['critical', 'high', 'medium', 'low']
              .map(k => {
                const val = parseInt(get(details, tool)?.[k] || '0');
                const cls = val === 0 ? 'green' : 'red';
                return `<span class="${cls}">${val}</span>`;
              });
            return vals.join(' | ');
          };

          row.innerHTML = `
            <td>${imageName}</td>
            <td>${sizeAmd}</td>
            <td>${sizeArm}</td>
            <td>${version}</td>
            <td>${cves('trivy')}</td>
            <td>${cves('grype')}</td>`;
          tbody.appendChild(row);
        }

        table.appendChild(tbody);

        const heading = document.createElement('h2');
        heading.textContent = `${appName.charAt(0).toUpperCase() + appName.slice(1)} (Upstream: ${upstream})`;
        container.appendChild(heading);
        container.appendChild(table);
      }
    }

    load();
  </script>
</body>
</html>
